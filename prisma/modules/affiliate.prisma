// ============================================================================
// AFFILIATE MODULE - Affiliate Programs, Referral Codes, Rewards, Payouts
// ============================================================================

enum AffiliateRewardType {
  REGISTRATION_CREDIT
  SUBSCRIPTION_COMMISSION
  BONUS
}

enum AffiliateRewardStatus {
  PENDING
  CLEARED
  CANCELLED
}

enum ReferralAttributionStatus {
  PENDING
  ACTIVE
  CANCELLED
}

model affiliate_programs {
  id                       String                     @id @default(cuid())
  name                     String
  isActive                 Boolean                    @default(false)
  registrationCredit       Int                        @default(0)
  baseCommissionRate       Decimal                    @default(0) @db.Decimal(10, 4)
  maxLevels                Int                        @default(1)
  subscriptionGraceDays    Int                        @default(3)
  rewardPendingDays        Int                        @default(14)
  lifetimeCommissions      Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  affiliate_program_levels affiliate_program_levels[]
  affiliate_rewards        affiliate_rewards[]
  referral_attributions    referral_attributions[]
  referral_codes           referral_codes[]
}

model affiliate_program_levels {
  id                 String             @id @default(cuid())
  programId          String
  level              Int
  commissionRate     Decimal            @default(0) @db.Decimal(10, 4)
  creditReward       Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  affiliate_programs affiliate_programs @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, level])
  @@index([programId])
}

model referral_codes {
  id                    String                  @id @default(cuid())
  programId             String
  code                  String                  @unique @db.Citext
  isActive              Boolean                 @default(true)
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  userId                String?                 @unique(map: "referral_codes_userid_key") @db.Uuid
  referral_attributions referral_attributions[]
  affiliate_programs    affiliate_programs      @relation(fields: [programId], references: [id], onDelete: Cascade)
  users                 users?                  @relation(fields: [userId], references: [id], onDelete: Cascade, map: "referral_codes_userid_fkey")

  @@index([programId])
}

model referral_attributions {
  id                  String                    @id @default(cuid())
  programId           String
  referralCodeId      String
  level               Int                       @default(1)
  status              ReferralAttributionStatus @default(PENDING)
  attributedAt        DateTime                  @default(now())
  activatedAt         DateTime?
  cancelledAt         DateTime?
  graceEndAt          DateTime?
  parentAttributionId String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  referrerUserId      String?                   @db.Uuid
  referredUserId      String?                   @db.Uuid
  affiliate_rewards   affiliate_rewards[]
  parentAttribution   referral_attributions?    @relation("ReferralParent", fields: [parentAttributionId], references: [id], onDelete: Cascade)
  childAttributions   referral_attributions[]   @relation("ReferralParent")
  affiliate_programs  affiliate_programs        @relation(fields: [programId], references: [id], onDelete: Cascade)
  referral_codes      referral_codes            @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  users_referred      users?                    @relation("ReferralReferred", fields: [referredUserId], references: [id], onDelete: Cascade, map: "referral_attributions_referreduserid_fkey")
  users_referrer      users?                    @relation("ReferralReferrer", fields: [referrerUserId], references: [id], onDelete: Cascade, map: "referral_attributions_referreruserid_fkey")

  @@index([programId])
  @@index([referralCodeId])
  @@index([referredUserId])
  @@index([referrerUserId])
  @@index([parentAttributionId])
}

model affiliate_rewards {
  id                    String                @id @default(cuid())
  programId             String
  attributionId         String
  type                  AffiliateRewardType
  level                 Int                   @default(1)
  currencyAmount        Decimal?              @db.Decimal(10, 2)
  currencyCode          String?               @db.VarChar(8)
  creditAmount          Int?                  @default(0)
  status                AffiliateRewardStatus @default(PENDING)
  pendingUntil          DateTime
  readyAt               DateTime?
  settledAt             DateTime?
  metadata              Json?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  userId                String?               @db.Uuid
  referral_attributions referral_attributions @relation(fields: [attributionId], references: [id], onDelete: Cascade)
  affiliate_programs    affiliate_programs    @relation(fields: [programId], references: [id], onDelete: Cascade)
  users                 users?                @relation(fields: [userId], references: [id], onDelete: Cascade, map: "affiliate_rewards_userid_fkey")

  @@index([programId])
  @@index([attributionId])
  @@index([status])
  @@index([metadata], map: "idx_affiliate_rewards_metadata_gin", type: Gin)
  @@index([userId])
}

model payout_audit_log {
  id           String   @id @default(cuid())
  rewardIds    Json
  action       String
  amount       Decimal? @db.Decimal(10, 2)
  currencyCode String?  @db.VarChar(8)
  performedBy  String
  notes        String?
  metadata     Json?
  createdAt    DateTime @default(now())
  userId       String?  @db.Uuid
  users        users?   @relation("payout_audit_log_user", fields: [userId], references: [id], onDelete: NoAction, map: "payout_audit_log_userid_fkey")

  @@index([performedBy])
  @@index([action])
  @@index([createdAt])
  @@index([rewardIds], map: "idx_payout_audit_log_rewardids_gin", type: Gin)
  @@index([userId])
}

model user_payout_profiles {
  id              String   @id @default(cuid())
  beneficiaryName String   @db.VarChar(255)
  taxCode         String?  @db.VarChar(32)
  vatNumber       String?  @db.VarChar(32)
  iban            String?  @db.VarChar(34)
  bicSwift        String?  @db.VarChar(11)
  addressLine1    String?  @db.VarChar(255)
  addressLine2    String?  @db.VarChar(255)
  city            String?  @db.VarChar(128)
  postalCode      String?  @db.VarChar(24)
  country         String?  @db.VarChar(2)
  taxResidence    String?  @db.VarChar(2)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String?  @unique(map: "user_payout_profiles_userid_key") @db.Uuid
  users           users?   @relation(fields: [userId], references: [id], onDelete: Cascade, map: "user_payout_profiles_userid_fkey")
}

